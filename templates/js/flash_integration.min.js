$(window).load(function(){initZsc();var a=$("#flashapp")[0];var b=function(c){var d=0;if(c.wheelDelta){d=c.wheelDelta/120;if(window.opera){d=-d}}else{if(c.detail){d=-c.detail*3}}this.onMouseWheel&&this.onMouseWheel(d);c.stopPropagation();c.preventDefault()};if(a){if(a.addEventListener){a.addEventListener("DOMMouseScroll",b,false);a.addEventListener("mousewheel",b,false)}else{if(a.attachEvent){a.attachEvent("onmousewheel",b)}}}$("#z_lang").bind("hide_z_lang",function(){hideScreenshot()});$("#z_lang").bind("show_z_lang",function(){showScreenshot(0.25,3,805306368)});startHideAppMonitor()});function ztrackCountSample(h,f,d,a,c,e,g,b){ztrackCount(f,d,a,c,e,g,b,h)}function ztrackCount(j,d,f,h,i,c,k,e){var b=jQuery.parseJSON(zaspVals);var g={zcounter:j,zkingdom:d||"",zphylum:f||"",zclass:h||"",zfamily:i||"",zgenus:c||"",zvalue:k||1,zsample:e||100};var a=callbackURL+"/ztrack/ztrack_flash.php?zaspSessionKey="+b.zaspSessionKey+"&zyAuthHash="+b.zyAuthHash+"&zySig="+b.zySig+"&zySnid="+b.zySnid;$.ajax({url:a,data:g,success:""})}function onSNAPIInit(){if(SNAPI.getNativeInterface().hasOwnProperty("Canvas")){SNAPI.getNativeInterface().Canvas.setUrlHandler(onUrl)}gameMessageInit()}function onUrl(a){SNAPI.ZSC.open()}var fbDialogTimerId=0;var fbDialogIsShowing=false;var zscIsShowing=false;function startHideAppMonitor(){if(fbDialogTimerId==0){fbDialogTimerId=setInterval(function(){var e=false;var a=document.getElementById("fb-root");if(a){var d=a.childNodes;for(var c=0;c<d.length;c++){var b=d[c];if(b.offsetTop>=0&&$(b).hasClass("fb_dialog")){e=true;break}}}if(e&&!fbDialogIsShowing){fbDialogIsShowing=true;showScreenshot(0.25,3,805306368)}else{if(!e&&fbDialogIsShowing){fbDialogIsShowing=false;hideScreenshot()}}if(SNAPI.ZSC.isOpen()&&!zscIsShowing){zscIsShowing=true;showScreenshot(0.25,3,805306368)}else{if(!SNAPI.ZSC.isOpen()&&zscIsShowing){zscIsShowing=false;hideScreenshot()}}},250)}}function stopHideAppMonitor(){clearInterval(fbDialogTimerId);fbDialogTimerId=0;if(fbDialogIsShowing){fbDialogIsShowing=false;hideScreenshot()}}function enableAllInput(){document.getElementById("flashapp").enableAllInput()}function disableAllInput(){document.getElementById("flashapp").disableAllInput()}function getAppFriendIds(){return g_appFriendIds}function getFriendData(){return g_friendData}function getUserInfo(){return g_userInfo}function getUserSession(){return SNAPI.sessionInformation[SNAPI.getSNID()].session}function getExperiments(){return g_experiments}function getLoadingScreenConfig(){return g_loadingScreenConfig}function callAmexFrame(){if($("#amexOverlay").is(":hidden")){showScreenshot(0.25,3,805306368);$("#amexOverlayFrame").attr("src",ZY.PrepareURL("amex_overlay.php"));$("#amexOverlay").show()}}function hideAmexOverlay(){hideScreenshot();$("#amexOverlay").hide();$("#amexOverlayFrame").attr("src","")}function updateProgressData(a){if(SNAPI.getSNID()==SNAPI.ZDC){SNAPI.GameMessages.send("gameLoading",{percent:a})}}var g_appRequestParams;var g_requestPayload;var g_requestCallback=null;function snapiRequestCallback(a){document.getElementById("flashapp").requestCallback(a)}function snapiRequestDone(a){if(g_requestCallback){g_requestCallback(a)}}function snapiRequestSNUID(a){if(!a||a.length==0){FB.ui({method:"apprequests",message:g_requestPayload.body,title:g_requestPayload.title,filter:["app_users"]},snapiRequestDone)}else{if(a.length>1){FB.ui({method:"apprequests",message:g_requestPayload.body,title:g_requestPayload.title,to:a},snapiRequestDone)}else{FB.ui({method:"apprequests",message:g_requestPayload.body,title:g_requestPayload.title,to:a[0]},snapiRequestDone)}}}function snapiSendRequestOld(b,d,c,a){var e={gameId:SNAPI.getCurrentGameId(1),toZid:b,type:"invite",data:d,eventTypeId:c,zid:SNAPI.getCurrentUserId()};SNAPI.api("request.send",e,function(f){snapiRequestDone()})}function snapiSendRequest(c,g,d,b,a){var f={gameId:g_gameId,toZid:c,type:b,data:g,eventTypeId:d};try{SNAPI.api("request.send",f,function(e){if(e!=null){document.getElementById("flashapp").requestDone(e,a)}else{document.getElementById("flashapp").onViralCanceled(a)}})}catch(h){document.getElementById("flashapp").onRequestError(h,a)}}function snapiGiftBack(b,d,c,e){var a=[b];if(e){g_requestCallback=e}snapiSendRequest(a,d,c,"gift")}var g_giftBackVid;var g_giftTo;var g_canvasUrl;var g_viralName;function giftBackCallback(a){if(a!=null){window.top.location=g_canvasUrl+"index.php?va=giftback&gbvid="+g_giftBackVid+"&giftTo="+g_giftTo+"&gbReq="+a[g_giftTo]+"&gbName="+g_viralName}else{window.top.location=g_canvasUrl+"index.php"}}function sendGiftBack(f,b,e,c,d){g_giftTo=f;g_giftBackVid=b;g_canvasUrl=d;g_gameId=c;var a=JSON.parse(e);g_viralName=a.viralName;$("#giftBackButton").hide();snapiGiftBack(f,a,14000,giftBackCallback)}function snapiGetPermission(a,b,c){SNAPI.api("users.getPermissions",{uid:b,perms:new Array(a)},function(d){var e="0";if(d[b]){if(d[b][a]){e=d[b][a]}}var f=document.getElementById("flashapp");f[c](b,a,e=="1")})}function snapiStreamPublish(i,f,a){if(i.full.media!=undefined&&i.full.media.src!=undefined&&i.full.media.href!=undefined){var b=[{type:"image",src:i.full.media.src,href:i.full.media.href}];i.full.media=b;i.simple.media=b}if(typeof g_locale=="undefined"){g_locale=null}if(i.activityStreamDisabled==undefined){var g=g_locale||g_userInfo.locale||"en_US";i.locale=g;i.version="v1"}var c={payload:i};if(a){c.display=a}try{var j=SNAPI.api("stream.publish",c,function(e){if(e){hideScreenshot(true);if(e.hasOwnProperty("error_code")&&e.error_code=="341"){document.getElementById("flashapp").onFeedRateLimitError(f)}else{if(e.hasOwnProperty("error_code")){document.getElementById("flashapp").onViralError(f,e)}else{document.getElementById("flashapp").onViralPublished(e,f)}}}else{document.getElementById("flashapp").onViralCanceled(f)}})}catch(d){hideScreenshot(true);var h="";if(d.name){h+=d.name}if(d.message){h+=d.message}if(h!=""){document.getElementById("flashapp").onViralError(f,{error_code:h})}else{document.getElementById("flashapp").onViralError(f)}}}function fbShare(g,c,a){var f={method:"/me/links/",display:"dialog",link:c,title:g.full.title,description:g.full.description,icon:g.full.media.src};try{FB.api("/me/links/","post",f,function(e){hideScreenshot(true);if(e&&e.id){document.getElementById("flashapp").onViralPublished(e,a)}else{hideScreenshot(true);document.getElementById("flashapp").onViralError(a,{error_code:"fbShare"})}})}catch(d){hideScreenshot(true);var b="";if(d.name){b+=d.name}if(d.message){b+=d.message}if(b!=""){document.getElementById("flashapp").onViralError(a,{error_code:b})}else{document.getElementById("flashapp").onViralError(a)}}}function fbShareUI(g,c,a){var f={method:"stream.share",display:"popup",u:c};try{FB.ui(f,function(e){hideScreenshot(true);if(e&&e.id){document.getElementById("flashapp").onViralPublished(e,a)}else{hideScreenshot(true);document.getElementById("flashapp").onViralError(a,{error_code:"fbShareUI"})}})}catch(d){hideScreenshot(true);var b="";if(d.name){b+=d.name}if(d.message){b+=d.message}if(b!=""){document.getElementById("flashapp").onViralError(a,{error_code:b})}else{document.getElementById("flashapp").onViralError(a)}}}function postCOGS(d){var a={};var c={};a.access_token=d.access_token;a[d.cogObject]=d.url;try{FB.api("/me/"+d.appNamespace+":"+d.cogAction,"post",a,function(e){if(!e||e.error){c={error:e.error.type+" "+e.error.message,action:d.cogAction,obj:d.object}}else{c={response:e.id,obj:d.object}}var f=callbackURL+"/ztrack/ztrack_cogs.php?zaspSessionKey="+d.zaspSessionKey+"&zyAuthHash="+d.zyAuthHash+"&zySig="+d.zySig+"&zySnid="+d.zySnid;$.ajax({url:f,data:c,success:""})})}catch(b){}}function postAchievements(d){var a={};var c={};a.access_token=d.access_token;a.achievement=d.name;try{FB.api("/me/achievements","post",a,function(e){if(!e||e.error){}})}catch(b){}}function movie(a){return document[a]}function embedGameSwf(d,h,k,l){var o=swfobject.getFlashPlayerVersion();var p=o.major+"."+o.minor+"."+o.release;var a={zcounter:"flash_version",zkingdom:p};var n=callbackURL+"/ztrack/ztrack_flash.php?zaspSessionKey="+l.zaspSessionKey+"&zyAuthHash="+l.zyAuthHash+"&zySig="+l.zySig+"&zySnid="+l.zySnid;$.ajax({url:n,data:a,success:""});var c={allowScriptAccess:"always",wmode:"window",allowFullScreen:"true"};var m={id:"flashapp",name:"flashapp"};var b=d.length/2;var g=false;for(var f=0;f<b;f++){var e=d[f*2];var j=d[f*2+1];if(swfobject.hasFlashPlayerVersion(e)){l.swfLocation=l.swfLocation[f*2+1];swfobject.embedSWF(j,"flashContent","100%",k,e,"playerProductInstall.swf",l,c,m);g=true;break}}if(!g){if(p=="0.0.0"){}else{$("#upgradeFlashLink").click(function(){sendVersionStats("upgrade");l.swfLocation=l.swfLocation[1];swfobject.embedSWF(d[1],"flashContent","100%",k,d[0],"playerProductInstall.swf",l,c,m)});$("#loadingPlaceholder").hide();$("#upgradeFlashPlaceholder").show()}}}function openZSC(){if(SNAPI_ENABLE&&ZSC_ENABLE){SNAPI.ZSC.open(true);var a=(+new Date/1000);ZscClientNotif.onZSCOpened();SNAPI.ZSC.addOnOpenedListener(function(){if(!zscIsShowing){var b=(+new Date/1000);var c=(b-a);c=c.toFixed(2);ztrackCount("debug_stats","zsc","time_to_open",c);zscIsShowing=true;showScreenshot(0.25,3,805306368)}});SNAPI.ZSC.addOnClosedListener(onZscClose)}}function onZscClose(){$.post(ZY.PrepareURL(callbackURL+"zsc/zsc_closed.php"),{timestamp:Math.round(+new Date/1000)});ZscClientNotif.onZSCClosed()}var ZCastleTabs=(function(){var a={};a.click=function(b){var c=document.getElementById("flashapp");if(typeof c.tabClick=="function"){c.tabClick(b)}};return a})();var CastlePayments=(function(){var g={};var a=null;var f=ZYNGA.PAYMENTS.PAYFRAME.getPayFrameInstance();f.addListener(d,"onAfterIframeClose");var i;var j;g.initialize=function(k,l){i=k;j=l};g.addToCart=function(u,v,n,s,z,w){if(u==0){return}if(v==0){return}if(typeof g_paymentHashes[u]=="undefined"){return}var m=1;var l=u;var x=v;var k=b;var o=h;var q=n;var t="DEFAULT_"+l;var y=g_paymentHashes[u];var p=SNAPI.getSNID();if(p==SNAPI.ZDC){m=6}var r=SNAPI.getConfig(p).session.user_id;if(SNAPI.getConfig(p).session.user_id){r=SNAPI.getConfig(p).session.user_id}else{r=parseInt(SNAPI.getConfig(p).session.zid)}if(z!=""){ZPURCHASE.item.override({title:z,description:w})}else{ZPURCHASE.item.override({description:w})}ZPURCHASE.price_card_code=t;console.log(r);ZPURCHASE.add_to_cart(j,p,r,m,l,x,k,o,q,i,y)};var b=function(k){if(k.success){var l=navigator.userAgent.toLowerCase();if(l.indexOf("msie")!=-1){var m=parseFloat(l.substring(l.indexOf("msie")+4));if(m==8){showScreenshot(0.25,3,805306368)}}}};var h=function(k){var l=navigator.userAgent.toLowerCase();if(l.indexOf("msie")!=-1){var m=parseFloat(l.substring(l.indexOf("msie")+4));if(m==8){hideScreenshot()}}};g.showPage=function(l,m){if(a==null){a=m;var k=jQuery.parseJSON(zaspVals);$.get(callbackURL+"payment.json",{type:l,zyAuthHash:k.zyAuthHash,zySig:k.zySig,zySnid:k.zySnid},function(n){var o={page:l,zugid:n.zugid,package_id:n.packageID,modal:{close_button:true},query_string_params:{sighash:n.sighash,encrypted_params:n.encrypted_params}};f.openPaymentIframe(o);$(m).addClass("selected")})}else{f.closePaymentIframe()}};function d(){$(a).removeClass("selected");a=null}g.openOffers=function(m,l,o){console.log("anand - open offers"+o);var q=l;var r=SNAPI.getSNID();var p=SNAPI.getConfig(r).session.user_id;var k=1;var n={zhash:o,gameid:q,snid:r,uid:p,appid:m,clientid:1,callback:function(s){e(s)},precallback:function(){showScreenshot(0.25,3,805306368)},zindex:101};if("oldflow"==o){console.log("anand - open offers with old flow get_offers");ZPAYMENTS.get_offers(q,r,p,k,c,e,m)}else{console.log("anand - open offers with new flow earn");ZPAYMENTS.earn(n)}};var c=function(k){if(k){}else{}};var e=function(k){hideScreenshot(true)};return g})();var ZscClientNotif=(function(){var c={};var f=new Array();var a=new Array();var e=false;var d=0;var b=false;c.onZSCOpened=function(){b=true};c.onZSCClosed=function(){b=false};c.Accept=function(g){var h=new Array(g.viralName,g.contextVars);if(b){f.push(h)}else{a.push(h);if(!e){d=1;e=true;setTimeout("ZscClientNotif.onServerResponseTimeout()",2000)}else{d++}}};c.onServerResponseTimeout=function(){d--;if(d<=0){if(a.length>0){var g=document.getElementById("flashapp");if(g&&g.processRequests&&typeof g.processRequests=="function"){g.processRequests()}}a=new Array();e=false;d=0}else{setTimeout("ZscClientNotif.onServerResponseTimeout()",500)}};c.ProcessRequests=function(k){try{var m=false;for(var g=0;g<f.length;g++){try{var h=new Array();h.push(f[g][0]);h.push(f[g][1]);var l=document.getElementById("flashapp");if(l&&l.onZscEvent&&typeof l.onZscEvent=="function"){l.onZscEvent(h)}m=true}catch(j){}}if(m){var l=document.getElementById("flashapp");if(l&&l.processRequests&&typeof l.processRequests=="function"){if(typeof k!="undefined"){l.processRequests(k)}else{l.processRequests()}}}}catch(j){}if(zscIsShowing){zscIsShowing=false;hideScreenshot()}f=[]};return c})();var ZscClientNotifGiftAccept=ZscClientNotif.GiftAccept;var ZscClientNotifInviteAccept=ZscClientNotif.InviteAccept;var ZscClientNotifHelpAccept=ZscClientNotif.HelpAccept;var ZscClientNotifAccept=ZscClientNotif.Accept;var gfc=(function(){var a={};a.HandleFeed=function(b,c){b=ZY.PrepareURL(b);$.ajax({url:b+"&_t=json&chunk=0",dataType:"json",success:function(g,j){var i=g;var e=j;if(g.accepted&&g.viralName){var h=g.senderVars||{};var f=g.receiverVars||{};ZscClientNotif.Accept({viralName:g.viralName,contextVars:{senderVars:h,receiverVars:f}});ZscClientNotif.ProcessRequests()}if(c){c(g)}},error:function(f,g){var d=f;var e=g}})};return a})();function refreshClientData(){var a=document.getElementById("flashapp");if(a&&a.runGrantGoodsOnClient&&typeof a.runGrantGoodsOnClient=="function"){a.runGrantGoodsOnClient(114)}}function muteGame(){var a=document.getElementById("flashapp");if(a&&a.muteGame&&typeof a.muteGame=="function"){a.muteGame(true)}}function unmuteGame(){var a=document.getElementById("flashapp");if(a&&a.muteGame&&typeof a.muteGame=="function"){a.muteGame(false)}}function gameMessageInit(){var b=document.getElementById("flashapp");if(!(b&&b.onZscEvent&&typeof b.onZscEvent=="function"&&typeof b.onZFriendsGameMessageReceived=="function")){setTimeout(gameMessageInit,250);return}var a=SNAPI.GameMessages;a.listen("invite",function(){ZCastleTabs.click("neighbor")});a.listen("gift",function(){ZCastleTabs.click("gift")});a.listen("handleFeed",function(c){gfc.HandleFeed(c.href,function(d){if(d.hasOwnProperty("statusMessage")){c.statusMessage=d.statusMessage}else{if(d.hasOwnProperty("errorMessage")){c.errorMessage=d.errorMessage}}a.send("feedHandled",c)})});a.listen("beforeDialogOpen",ZYFrameManager.freezeFlash);a.listen("afterDialogClose",ZYFrameManager.unfreezeFlash);a.listen("goodsGranted",refreshClientData);a.listen("sleep",muteGame);a.listen("wake",unmuteGame);if(SNAPI.getSNID()==SNAPI.ZGN){loadZFriends()}}var wasZFriendsGameMessageReceived=false;function loadZFriends(){SNAPI.GameMessages.listen("zFriends",function(a){onZFriendsGameMessageReceived(a)});SNAPI.GameMessages.once("zFriends",function(){var a=SNAPI.GameMessages.send("zFriends");if(a){if(g_zFriendsGameMessageTimeout>0){setTimeout(onZFriendsGameMessageCallFailure,g_zFriendsGameMessageTimeout)}}else{onZFriendsGameMessageCallFailure(0)}})}function onZFriendsGameMessageCallFailure(c){if(typeof c=="undefined"){c=0}if(wasZFriendsGameMessageReceived||c>g_zFriendsScriptMaxRetries){return}var a=jQuery.parseJSON(zaspVals);var b=callbackURL+"zdc/get_zfriends.php?zaspSessionKey="+a.zaspSessionKey+"&zyAuthHash="+a.zyAuthHash+"&zySig="+a.zySig+"&zySnid="+a.zySnid+"&retryCount="+c;$.ajax({url:b,dataType:"json",timeout:10000,success:function(d){onZFriendsGameMessageReceived(d)},error:function(d){onZFriendsGameMessageCallFailure(c+1)}})}function onZFriendsGameMessageReceived(a){if(!wasZFriendsGameMessageReceived){wasZFriendsGameMessageReceived=true;document.getElementById("flashapp").onZFriendsGameMessageReceived(a)}}var zbarInited=false;var adsInited=false;CastlePopup=(function(){var h;h={};function g(j){return"pop_"+j}function a(j){return"pop_bg_"+j}function f(j){return"pop_box_"+j}function i(n,j){var k,l,m;if(typeof j=="number"&&j>=0){return setTimeout(function(){i(n)},j)}else{k=$("#interstitialOverlay");l=$("#"+g(n));m=function(o){hideInnerFlash();k.height(k.parent().parent().parent().height());k.show();if(l.hasClass("pop_prevent_fade")){l.show()}else{l.fadeIn(150)}};m()}}function d(k,j){b(k,false,j)}function e(k,j){b(k,true,j)}function b(o,j,l){var m,n,k;if(typeof l=="number"&&l>=0){return setTimeout(function(){b(o,j)},l)}else{m=$("#interstitialOverlay").hide();n=$("#"+g(o));if(j){n.fadeOut(150,function(){$("#"+g(o)).remove()})}else{n.fadeOut(150)}if(!zscIsShowing){showInnerFlash()}}}function c(j){$("#"+f(j)+" .pop_box_close").click(function(){CastlePopup.hide(j)})}h.registerClose=function(j){c(j)};h.show=function(k,j){i(k,j)};h.hide=function(k,j){d(k,j)};h.hideAndRemove=function(k,j){e(k,j)};return h}());function showZCachePromptIcon(){$("#zCachePromptIcon").click(function(){var a=document.getElementById("flashapp");a.showZCachePrompt()});$("#zCachePromptIcon").show()}function hideZCachePromptIcon(){$("#zCachePromptIcon").hide();$("#zCachePromptIcon").remove()}function startNowAskForFBPerms(a){if(!a){a=["email","publish_actions"]}FB.login(function(b){FB.api("/me/permissions",{limit:0},function(g){var f=g.data[0];var e=true;var h=a.length;for(var d=0;d<h;d++){var c=a[d];if(!f.hasOwnProperty(c)||f[c]!=1){e=false;break}}if(e){document.getElementById("flashapp").startNowAskForFBPermsResponse(true)}else{document.getElementById("flashapp").startNowAskForFBPermsResponse(false)}})},{scope:a.join()})}var ZTrackQuery=(function(){var b={};var a=new Array();var c=null;b.GetKey=function(e,f){var d=callbackURL+"/ztrack/ztrack_callback.php";c=f;$.ajax({url:d,data:e,success:b.KeyReceived})};b.KeyReceived=function(e){var f=document.getElementById("flashapp");if(!f){alert("Could not find flash client")}if(c!=null&&typeof f[c]=="function"){if(e!=null&&"key" in e&&e.key.length>0){var d={result:"Success",key:e.key,keyMsgCtr:e.keyMsgCtr};f[c](d)}else{var d={result:"Error",message:"no Key returned"};f[c](d)}}else{alert("Flash client callback not found")}};return b})();function getZTrackKey(e,d,h,c,b,a,g){var f={channel:e,category:d,subcategory:h,family:c,genus:b,userId:a};ZTrackQuery.GetKey(f,g)}function TestZTrackCall(){var a={};ZTrackQuery.GetKey(a)};