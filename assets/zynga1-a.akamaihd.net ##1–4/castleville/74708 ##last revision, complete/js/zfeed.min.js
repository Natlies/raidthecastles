(function(){var e=(function(g){var f=typeof window!=="undefined"?window:global;var j=f.hasOwnProperty(g);var i=f[g];var h=f[g]={};h.noConflict=function(){delete f[g];if(j){f[g]=i}return this};return h}("zFeed"));e.VERSION="0.1.2";e.feeds={};e.defaults={selector:"#zfeed",friends:null,limit:20,gameId:0,last:undefined,last_per:{},action:undefined,doTrack:true,profile:"http://profile.ak.fbcdn.net/static-ak/rsrc.php/v1/yL/r/HsTZSDw4avx.gif",spinner:"http://i.imgur.com/fq7T6.gif",api:{getFriends:function(g){var f={method:"friends.get",payload:{},callback:g};e.log(["zFeed","getFriends","Request",f]);DAPI.api.send(f);DAPI.api.flush()},getFeeds:function(g,h){var f={method:"stream.getList",payload:g,callback:h};e.log(["zFeed","getFeeds","Request",f]);DAPI.api.send(f);DAPI.api.flush()},optOut:function(g){var f={method:"stream.optOut",payload:{},callback:g};e.log(["zFeed","optOut","Request",f]);DAPI.api.send(f);DAPI.api.flush()},optIn:function(g){var f={method:"stream.optIn",payload:{},callback:g};e.log(["zFeed","optIn","Request",f]);DAPI.api.send(f);DAPI.api.flush()},trackClick:function(g){var f={method:"Track.logCount",payload:g};e.log(["zFeed","trackClick","Request",f]);DAPI.api.send(f);DAPI.api.flush()},getInfo:function(g,h){var f={"-1":{id:"-1",name:"a Zynga game",link:"http://www.zynga.com",icon_tiny:"https://zynga1-a.akamaihd.net/zlive/zdc-58243-static/js/compiled/zui/modules/widgets/zdc/home/gamechiclet/bg_badge.png",icon_normal:"https://zynga1-a.akamaihd.net/zlive/zdc-58243-static/images/common_web/header/zdc-hdr-logo.png"},"63":{id:"102452128776",name:"FarmVille",link:"http://www.facebook.com/apps/application.php?id=102452128776",icon_tiny:"http://photos-g.ak.fbcdn.net/photos-ak-snc1/v85005/144/102452128776/app_2_102452128776_1812516670.gif",icon_normal:"http://photos-f.ak.fbcdn.net/photos-ak-snc1/v85005/144/102452128776/app_1_102452128776_1856684156.gif"},"75":{id:"291549705119",name:"CityVille",link:"http://www.facebook.com/apps/application.php?id=291549705119",icon_tiny:"http://photos-f.ak.fbcdn.net/photos-ak-snc1/v85006/71/291549705119/app_2_291549705119_857480757.gif",icon_normal:"http://photos-f.ak.fbcdn.net/photos-ak-snc1/v27562/71/291549705119/app_1_291549705119_514.gif"},"223":{id:"107040076067341",name:"CastleVille",link:"http://www.facebook.com/apps/application.php?id=107040076067341",icon_tiny:"http://photos-e.ak.fbcdn.net/photos-ak-snc1/v85006/109/107040076067341/app_2_107040076067341_1894992473.gif",icon_normal:"http://photos-b.ak.fbcdn.net/photos-ak-snc1/v85006/109/107040076067341/app_1_107040076067341_1528.gif"}};if("gid" in g&&g.gid!==undefined){if(g.gid in f){h(f[g.gid])}else{h(f["-1"])}}else{h(f)}}}};e.settings=null;e.log=function c(f){if(console&&console.log){console.log(f)}};e.init=function(f){e.load_jquery_plugin();e.settings=$.extend(true,{},e.defaults,f);if(!$.isArray(e.settings.games)){e.settings.ratios=e.settings.games;e.settings.games=$.map(e.settings.games,function(h,g){return g})}e.div=$(e.settings.selector).addClass("zfeed_root");e.div.html("<div class='zfeed_main zfeed_left'><ul class='zfeed_border'><li class='zfeed_center zfeed_spinner'><img src='"+e.settings.spinner+"'/></ul></div><div class='zfeed_clear'/>");e.settings.api.getFriends(e.init_callback);e.settings.api.getInfo({},function(g){e.log(["getInfo",g]);e.settings.info=g})};e.init_callback=function(f){e.log(["zFeed","getFriends","Result",f]);e.settings.friends={};e.settings.friend_list=[];$.each(f,function(g,h){e.settings.friends[h.zid]=h;e.settings.friend_list[g]=h.zid});e.fetch()};e.more=function(){e.div.find("ul li.zfeed_more").removeClass("zfeed_more").addClass("zfeed_spinner").html("<img src='"+e.settings.spinner+"'/>");e.fetch()};e.fetch=function(){var f={};if(e.settings.ratios!==undefined){f.limit_by_game={};$.each(e.settings.ratios,function(h,i){f.limit_by_game[h]={gameLimit:e.settings.limit*i,endTime:e.settings.last_per[h]}})}var g={games:e.settings.games,friendsZids:e.settings.friend_list,startTime:undefined,endTime:e.settings.last,limit:e.settings.limit,types:["gf","fwpf","impf","ff"],timeoutMilliSec:15000,reload:true,optionals:f};e.settings.api.getFeeds(g,e.fetch_callback)};e.fetch_callback=function(f){if(f===undefined||f===null){e.log(["zFeed","getFeeds","Error",f]);e.div.find(".zfeed_spinner").remove();e.div.find("ul").append("<li class='zfeed_center zfeed_more'><p>No Feeds</p><button onclick='zFeed.more()'>Load More</button></li>");return}if(f.error!==undefined){e.log(["zFeed","getFeeds","Error",f]);if(f.error=="stream.optout: stream error"){e.div.find("ul").empty().append("<li class='zfeed_center'><button onclick='zFeed.optIn()'>Join Zynga Feeds</button></p></li>");return}e.div.find("ul").append("<li class='zfeed_center zfeed_more'><p>There was an error</p><button onclick='zFeed.more()'>Load More</button></li>");return}e.log(["zFeed","getFeeds","Result",f]);e.div.find(".zfeed_spinner").remove();$.each(f,function(g,h){e.insert(h)});e.div.find("ul").append("<li class='zfeed_center zfeed_more'><button onclick='zFeed.more()'>Load More</button><br/><button onclick='zFeed.optOut()'>Disable</button></li>")};e.insert=function(h){if(h.id in e.feeds){e.log("Already Listed "+h.id);return false}if(!e.valid(h)){e.log("Nonvalid Feed");return false}if("profile" in h&&typeof h.profile==="string"){h.profile=JSON.parse(h.profile)}if("attachment" in h&&"media" in h.attachment&&typeof h.attachment.media==="string"){h.attachment.media=JSON.parse(h.attachment.media)}e.feeds[h.id]=h;e.log([h.id,h]);var f=e.getFeedHTML(h);var g=e.div.find("ul");g.append(f);$("abbr.timeago").timeago();if(e.settings.last===undefined||e.settings.last>h.created_time){e.settings.last=h.created_time}if(e.settings.last_per[h.game_id]===undefined||e.settings.last_per[h.game_id]>h.created_time){e.settings.last_per[h.game_id]=h.created_time}return true};e.optOut=function(f){e.settings.api.optOut(function(g){e.log(["zFeed","optOut","Result",g]);e.feeds=[];e.div.find("ul").empty().append("<li class='zfeed_center'><button onclick='zFeed.optIn()'>Join Zynga Feeds</button></p></li>")})};e.optIn=function(){e.settings.api.optIn(function(f){e.log(["zFeed","optIn","Result",f]);e.div.find("ul").empty().append("<li class='zfeed_center zfeed_spinner'><img src='"+e.settings.spinner+"'/></li>");e.fetch();return})};e.actionClick=function(g,i){if(!(g in e.feeds)){e.log(["zFeed","Error","actionClick","Unknown Feed",g]);return false}if(!(i in e.feeds[g].action_links)){e.log(["zFeed","Error","actionClick","Unknown Action",g,i]);return false}if(e.settings.action!==undefined&&typeof e.settings.action==="function"){e.log(["zFeed","Action","Running Function",e.settings.action]);var h=e.settings.action(e.feeds[g],i);if(h){return false}}var f=e.decode(e.feeds[g].action_links[i].href);window.open(f);if(e.settings.doTrack){var j={clientId:1027,zid:DAPI.getCurrentUser(),counter:"zfeed_widget",value:"1",key1:e.feeds[g].game_id,key2:e.settings.gameId,key3:e.feeds[g].action_links[i].text};e.settings.api.trackClick(j)}e.log(["zFeed","Action","Default",f]);return false};e.getSafeFeedId=function d(f){return"zfeed_"+f.replace(":","-")};e.getRealFeedId=function a(f){return f.replace("_",":")};e.valid=function(f){if(!("attachment" in f)||!("media" in f.attachment)){return false}return true};e.encode=function(f){return String(f).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;")};e.decode=function(f){return String(f).replace(/&amp;/g,"&").replace(/&quot/g,'"').replace(/&#39;/g,"'").replace(/&lt;/g,"<").replace(/&gt;/g,">")};e.getFeedHTML=function b(h){var f=e.settings.info["-1"];if(h.game_id in e.settings.info){f=e.settings.info[h.game_id]}var i="";i+='<li id="'+e.getSafeFeedId(h.id)+'">';i+='	<div class="image"><img src="'+h.attachment.media[0].src+'" class="feedImage" /></div>';i+='	<div class="content">';i+='		<div class="top">';if("from" in h&&h.from in e.settings.friends){i+='			<div class="profile_image"><img src="'+e.settings.friends[h.from].pic+'"/></div>'}else{i+='			<div class="profile_image"><img src="'+e.settings.profile+'"/></div>'}i+='			<div class="profile_content">';i+='				<div class="name">'+h.from_name+"</div>";i+='				<div class="title">'+h.attachment.name+"</div>";i+="			</div>";i+='			<div style="clear:both"></div>';i+="		</div>";i+='		<div style="clear:both"></div>';i+='		<div class="bottom">';i+='			<div class="game_image"><img src="'+f.icon_tiny+'"></div>';i+="			<span></span>";$.each(h.action_links,function(j,k){i+='			<div class="action"><a class="action" onclick="zFeed.actionClick(\''+h.id+"', "+j+');">'+k.text+"</a></div>";i+="			<span></span>"});var g=new Date(h.created_time*1000);i+='			<div class="time"><abbr class="timeago" id="timeago_'+e.getSafeFeedId(h.id)+'" title="'+g.toISOString()+'">'+g+"</abbr></div>";i+="			<span>via</span>";i+='			<div class="game">'+f.name+"</div>";i+='			<div style="clear:both"/>';i+="		</div>";i+='		<div style="clear:both"/>';i+="	</div>";i+='	<div style="clear:both"/>';i+="</li>";return i};e.load_jquery_plugin=function(){$.timeago=function(k){if(k instanceof Date){return f(k)}else{if(typeof k==="string"){return f($.timeago.parse(k))}else{return f($.timeago.datetime(k))}}};var j=$.timeago;$.extend($.timeago,{settings:{refreshMillis:60000,allowFuture:false,strings:{prefixAgo:null,prefixFromNow:null,suffixAgo:"ago",suffixFromNow:"from now",seconds:"less than a minute",minute:"about a minute",minutes:"%d minutes",hour:"about an hour",hours:"about %d hours",day:"a day",days:"%d days",month:"about a month",months:"%d months",year:"about a year",years:"%d years",wordSeparator:" ",numbers:[]}},inWords:function(q){var r=this.settings.strings;var n=r.prefixAgo;var v=r.suffixAgo;if(this.settings.allowFuture){if(q<0){n=r.prefixFromNow;v=r.suffixFromNow}}var t=Math.abs(q)/1000;var k=t/60;var s=k/60;var u=s/24;var o=u/365;function m(w,y){var x=$.isFunction(w)?w(y,q):w;var z=(r.numbers&&r.numbers[y])||y;return x.replace(/%d/i,z)}var p=t<45&&m(r.seconds,Math.round(t))||t<90&&m(r.minute,1)||k<45&&m(r.minutes,Math.round(k))||k<90&&m(r.hour,1)||s<24&&m(r.hours,Math.round(s))||s<42&&m(r.day,1)||u<30&&m(r.days,Math.round(u))||u<45&&m(r.month,1)||u<365&&m(r.months,Math.round(u/30))||o<1.5&&m(r.year,1)||m(r.years,Math.round(o));var l=r.wordSeparator===undefined?" ":r.wordSeparator;return $.trim([n,p,v].join(l))},parse:function(l){var k=$.trim(l);k=k.replace(/\.\d\d\d+/,"");k=k.replace(/-/,"/").replace(/-/,"/");k=k.replace(/T/," ").replace(/Z/," UTC");k=k.replace(/([\+\-]\d\d)\:?(\d\d)/," $1$2");return new Date(k)},datetime:function(l){var m=$(l).get(0).tagName.toLowerCase()==="time";var k=m?$(l).attr("datetime"):$(l).attr("title");return j.parse(k)}});$.fn.timeago=function(){var l=this;l.each(h);var k=j.settings;if(k.refreshMillis>0){setInterval(function(){l.each(h)},k.refreshMillis)}return l};function h(){var k=g(this);if(!isNaN(k.datetime)){$(this).text(f(k.datetime))}return this}function g(k){k=$(k);if(!k.data("timeago")){k.data("timeago",{datetime:j.datetime(k)});var l=$.trim(k.text());if(l.length>0){k.attr("title",l)}}return k.data("timeago")}function f(k){return j.inWords(i(k))}function i(k){return(new Date().getTime()-k.getTime())}document.createElement("abbr");document.createElement("time")}}());